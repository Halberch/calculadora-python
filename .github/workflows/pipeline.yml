name: Complete CI/CD Pipeline

permissions:
  contents: read
  security-events: write

# Triggers on push or pull request to the main branch
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # JOB 1: Linter and Tests (Q1, Q2, Q4-Linter)
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - uses: actions/checkout@v4

      - name: Pipeline context and timestamps
        run: |
          echo "Pipeline started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Runner OS: $RUNNER_OS"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Branch/Ref: $GITHUB_REF"
          echo "Commit SHA: $GITHUB_SHA"

      # 2. Set up Python 3.10
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 3. Build (Install dependencies)
      - name: Install dependencies
        run: |
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Installing dependencies..."
          python -m pip install --upgrade pip
          pip install flake8 pytest
          pip install -r requirements.txt
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Installed packages:"
          pip list
          
      # 4 Linting (Static Analysis)
      - name: Lint with Flake8 (Q4)
        run: |
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Running flake8..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Flake8 completed"

      # 5. Test (Run tests Q1)
      - name: Run Unit Tests with Pytest
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Running unit tests..."
          pytest -vv -s tests/unit
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Unit tests completed"

      # 6. Test (Run Integration tests Q2)
      - name: Run Integration Tests with Pytest
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Running integration tests..."
          pytest -vv -s tests/integration
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Integration tests completed"

  # JOB 2: Security with Snyk (Q4 - Security End-to-End)
  security-snyk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        continue-on-error: true 
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --sarif-file-output=snyk.sarif --file=requirements.txt --skip-unresolved

      - name: Upload result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk.sarif

  # JOB 3: CD (Continuous Deployment) - Docker Simulation
  deploy:
    needs: [build-and-test, security-snyk]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: |
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] ðŸ“¦ Building Docker image..."
          docker build -t calculator-app:latest .
          
      - name: Simulate Deployment (Run Docker Container)
        run: |
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] ðŸš€ Deploying container to simulated Production environment..."
          docker run -d -p 5000:5000 --name app-production calculator-app:latest
          
      - name: Verify Deployment (Healthcheck)
        run: |
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] âœ… Checking if the container is running..."
          sleep 5
          docker ps | grep app-production
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] ðŸŽ‰ Continuous Deployment (CD) completed successfully!"